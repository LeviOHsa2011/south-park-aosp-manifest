name: South Park AOSP Build 11-10
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360 

    steps:
      - name: Checkout dein Repo
        uses: actions/checkout@v4

      - name: Free Disk Space (The 11/10 Clean)
        run: |
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/lib/jvm
          # Zusätzliche Gigabytes freischaufeln
          sudo rm -rf /usr/share/swift /usr/local/share/powershell /usr/local/lib/node_modules
          df -h

      - name: Install Build Dependencies
        run: |
          sudo apt update
          sudo apt install -y bc build-essential zip curl libstdc++6 git python3 python-is-python3 libssl-dev libncurses5-dev x11proto-core-dev libx11-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig

      - name: Install Repo Tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Sync Full AOSP (Android 14)
        run: |
          # Wir laden NUR arm64 und NUR das Nötigste (-g all,-notdefault,-device,-mips,-x86,-darwin)
          repo init -u https://android.googlesource.com/platform/manifest -b android-14.0.0_r1 --depth=1 -g all,-notdefault,-device,-mips,-x86,-darwin
          repo sync -c -j$(nproc --all) --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync

      - name: Inject South Park DNA
        run: |
          mkdir -p vendor/southpark/assets
          # Falls du die Ordner lokal in deinem Repo hast, kopieren wir sie jetzt ins AOSP-Verzeichnis
          cp -r assets/* vendor/southpark/assets/ || echo "Keine Assets gefunden"
          # Hier können wir später deine Kotlin-Patches einfügen

      - name: Compile System Image
        run: |
          source build/envsetup.sh
          lunch aosp_arm64-eng
          # 'make' braucht viel RAM, wir begrenzen die Jobs etwas, um Abstürze zu vermeiden
          make systemimage -j$(nproc --all)

      - name: Upload Finished Image
        uses: actions/upload-artifact@v4
        with:
          name: South-Park-OS-Image
          # Der Pfad kann variieren, wir nutzen Wildcards zur Sicherheit
          path: out/target/product/*/system.img
